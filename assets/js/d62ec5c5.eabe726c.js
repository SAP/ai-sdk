"use strict";(self.webpackChunksap_ai_sdk_documentation=self.webpackChunksap_ai_sdk_documentation||[]).push([[938],{4659:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>a,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"guides/openai-chat-completion","title":"OpenAI Chat Completion","description":"How to use the SAP AI SDK for Java to perform chat completion tasks using OpenAI models deployed on SAP AI Core.","source":"@site/docs-java/guides/openai-chat-completion.mdx","sourceDirName":"guides","slug":"/guides/openai-chat-completion","permalink":"/docs/java/guides/openai-chat-completion","draft":false,"unlisted":false,"editUrl":"https://github.com/SAP/ai-sdk/edit/main/docs-java/guides/openai-chat-completion.mdx","tags":[],"version":"current","frontMatter":{"id":"openai-chat-completion","title":"OpenAI Chat Completion","hide_title":false,"hide_table_of_contents":false,"description":"How to use the SAP AI SDK for Java to perform chat completion tasks using OpenAI models deployed on SAP AI Core.","keywords":["sap","cloud","sdk","ai"]},"sidebar":"docsJavaSidebar","previous":{"title":"AI Core Deployment","permalink":"/docs/java/guides/ai-core-deployment"},"next":{"title":"Orchestration Chat Completion","permalink":"/docs/java/guides/orchestration-chat-completion"}}');var i=t(4848),o=t(8453);const a={id:"openai-chat-completion",title:"OpenAI Chat Completion",hide_title:!1,hide_table_of_contents:!1,description:"How to use the SAP AI SDK for Java to perform chat completion tasks using OpenAI models deployed on SAP AI Core.",keywords:["sap","cloud","sdk","ai"]},r=void 0,l={},d=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"Introduction",id:"introduction",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Maven Dependencies",id:"maven-dependencies",level:3},{value:"Usage",id:"usage",level:2},{value:"Simple chat completion",id:"simple-chat-completion",level:2},{value:"Using a Custom Resource Group",id:"using-a-custom-resource-group",level:2},{value:"Message history",id:"message-history",level:2},{value:"Chat Completion with Specific Model Version",id:"chat-completion-with-specific-model-version",level:2},{value:"Chat completion with Custom Model",id:"chat-completion-with-custom-model",level:2},{value:"Stream chat completion",id:"stream-chat-completion",level:2},{value:"Asynchronous Streaming",id:"asynchronous-streaming",level:3},{value:"Aggregating Total Output",id:"aggregating-total-output",level:3},{value:"Embedding",id:"embedding",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components},{Details:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#introduction",children:"Introduction"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#prerequisites",children:"Prerequisites"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#maven-dependencies",children:"Maven Dependencies"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"#usage",children:"Usage"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#simple-chat-completion",children:"Simple Chat Completion"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#message-history",children:"Message History"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#chat-completion-with-custom-model",children:"Chat Completion with Custom Model"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"#stream-chat-completion",children:"Stream Chat Completion"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#asynchronous-streaming",children:"Asynchronous Streaming"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#aggregating-total-output",children:"Aggregating Total Output"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#spring-boot-example",children:"Spring Boot Example"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(n.p,{children:"This guide demonstrates how to use the SAP AI SDK for Java to perform chat completion tasks using OpenAI models deployed on SAP AI Core."}),"\n",(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsxs)(n.p,{children:["All classes under any of the ",(0,i.jsx)(n.code,{children:"...model"})," packages are generated from an OpenAPI specification and marked as ",(0,i.jsx)(n.code,{children:"@Beta"}),".\nThis means that these model classes are not guaranteed to be stable and may change with future releases.\nThey are safe to use, but may require updates even in minor releases."]})}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsxs)(n.p,{children:["Before using the AI Core module, ensure that you have met all the general requirements outlined in the ",(0,i.jsx)(n.a,{href:"../overview-cloud-sdk-for-ai-java#general-requirements",children:"overview"}),".\nAdditionally, include the necessary Maven dependency in your project."]}),"\n",(0,i.jsx)(n.h3,{id:"maven-dependencies",children:"Maven Dependencies"}),"\n",(0,i.jsxs)(n.p,{children:["Add the following dependency to your ",(0,i.jsx)(n.code,{children:"pom.xml"})," file:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"<dependencies>\n    <dependency>\n        <groupId>com.sap.ai.sdk.foundationmodels</groupId>\n        <artifactId>openai</artifactId>\n        <version>${ai-sdk.version}</version>\n    </dependency>\n</dependencies>\n"})}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"https://github.com/SAP/ai-sdk-java/tree/main/sample-code/spring-app/pom.xml",children:"an example pom in our Spring Boot application"})]}),"\n",(0,i.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,i.jsx)(n.p,{children:"In addition to the prerequisites above, we assume you have already set up the following to carry out the examples in this guide:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"A Deployed OpenAI Model in SAP AI Core"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Refer\nto ",(0,i.jsx)(n.a,{href:"https://help.sap.com/docs/sap-ai-core/sap-ai-core-service-guide/create-deployment-for-generative-ai-model-in-sap-ai-core",children:"How to deploy a model to AI Core"}),"\nfor setup instructions."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["In case the model is deployed in a custom resource group, refer to ",(0,i.jsx)(n.a,{href:"#using-a-custom-resource-group",children:"this section"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(t,{children:[(0,i.jsxs)("summary",{children:["Example deployed model from the AI Core ",(0,i.jsx)("code",{children:"/deployments"})," endpoint"]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "id": "d123456abcdefg",\n  "deploymentUrl": "https://api.ai.region.aws.ml.hana.ondemand.com/v2/inference/deployments/d123456abcdefg",\n  "configurationId": "12345-123-123-123-123456abcdefg",\n  "configurationName": "gpt-35-turbo",\n  "scenarioId": "foundation-models",\n  "status": "RUNNING",\n  "statusMessage": null,\n  "targetStatus": "RUNNING",\n  "lastOperation": "CREATE",\n  "latestRunningConfigurationId": "12345-123-123-123-123456abcdefg",\n  "ttl": null,\n  "details": {\n    "scaling": {\n      "backendDetails": {}\n    },\n    "resources": {\n      "backendDetails": {\n        "model": {\n          "name": "gpt-35-turbo",\n          "version": "latest"\n        }\n      }\n    }\n  },\n  "createdAt": "2024-07-03T12:44:22Z",\n  "modifiedAt": "2024-07-16T12:44:19Z",\n  "submissionTime": "2024-07-03T12:44:51Z",\n  "startTime": "2024-07-03T12:45:56Z",\n  "completionTime": null\n}\n'})})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"simple-chat-completion",children:"Simple chat completion"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'var result =\n    OpenAiClient.forModel(GPT_35_TURBO)\n        .withSystemPrompt("You are a helpful AI")\n        .chatCompletion("Hello World! Why is this phrase so famous?");\n\nString resultMessage = result.getContent();\n'})}),"\n",(0,i.jsx)(n.h2,{id:"using-a-custom-resource-group",children:"Using a Custom Resource Group"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'var destination = new AiCoreService()\n    .getInferenceDestination("custom-rg")\n    .forModel(GPT_4O);\nOpenAiClient.withCustomDestination(destination);\n'})}),"\n",(0,i.jsx)(n.h2,{id:"message-history",children:"Message history"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'var systemMessage =\n    new OpenAiChatSystemMessage().setContent("You are a helpful assistant");\nvar userMessage =\n    new OpenAiChatUserMessage().addText("Hello World! Why is this phrase so famous?");\nvar request =\n    new OpenAiChatCompletionParameters().addMessages(systemMessage, userMessage);\n\nvar result = OpenAiClient.forModel(GPT_35_TURBO).chatCompletion(request);\n\nString resultMessage = result.getContent();\n'})}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"https://github.com/SAP/ai-sdk-java/tree/main/sample-code/spring-app/src/main/java/com/sap/ai/sdk/app/services/OpenAiService.java",children:"an example in our Spring Boot application"})]}),"\n",(0,i.jsx)(n.h2,{id:"chat-completion-with-specific-model-version",children:"Chat Completion with Specific Model Version"}),"\n",(0,i.jsx)(n.p,{children:"By default, when no version is specified, the system selects one of the available deployments of the specified model, regardless of its version.\nTo target a specific version, you can specify the model version along with the model."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'OpenAiChatCompletionOutput result =\n    OpenAiClient.forModel(GPT_35_TURBO.withVersion("1106")).chatCompletion(request);\n'})}),"\n",(0,i.jsx)(n.h2,{id:"chat-completion-with-custom-model",children:"Chat completion with Custom Model"}),"\n",(0,i.jsxs)(n.p,{children:["You can also use a custom OpenAI model for chat completion by creating an ",(0,i.jsx)(n.code,{children:"OpenAiModel"})," object."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'OpenAiChatCompletionOutput result =\n    OpenAiClient.forModel(new OpenAiModel("custom-model", "v1")).chatCompletion(request);\n'})}),"\n",(0,i.jsx)(n.p,{children:"Ensure that the custom model is deployed in SAP AI Core."}),"\n",(0,i.jsx)(n.h2,{id:"stream-chat-completion",children:"Stream chat completion"}),"\n",(0,i.jsx)(n.p,{children:"It's possible to pass a stream of chat completion delta elements, e.g. from the application backend to the frontend in real-time."}),"\n",(0,i.jsx)(n.h3,{id:"asynchronous-streaming",children:"Asynchronous Streaming"}),"\n",(0,i.jsx)(n.p,{children:"This is a blocking example for streaming and printing directly to the console:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'String msg = "Can you give me the first 100 numbers of the Fibonacci sequence?";\n\nOpenAiClient client = OpenAiClient.forModel(GPT_35_TURBO);\n\n// try-with-resources on stream ensures the connection will be closed\ntry (Stream<String> stream = client.streamChatCompletion(msg)) {\n    stream.forEach(\n        deltaString -> {\n            System.out.print(deltaString);\n            System.out.flush();\n        });\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"aggregating-total-output",children:"Aggregating Total Output"}),"\n",(0,i.jsx)(n.p,{children:"The following example is non-blocking and demonstrates how to aggregate the complete response.\nAny asynchronous library can be used, such as the classic Thread API."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'var message = "Can you give me the first 100 numbers of the Fibonacci sequence?";\n\nvar userMessage =\n    new OpenAiChatMessage.OpenAiChatUserMessage().addText(message);\nvar requestParameters =\n    new OpenAiChatCompletionParameters().addMessages(userMessage);\n\nvar client = OpenAiClient.forModel(GPT_35_TURBO);\nvar totalOutput = new OpenAiChatCompletionOutput();\n\n// Prepare the stream before starting the thread to handle any initialization exceptions\nStream<OpenAiChatCompletionDelta> stream =\n    client.streamChatCompletionDeltas(requestParameters);\n\nvar streamProcessor =\n    new Thread(\n        () -> {\n          // try-with-resources ensures the stream is closed after processing\n          try (stream) {\n            stream.peek(totalOutput::addDelta).forEach(System.out::println);\n          }\n        });\n\nstreamProcessor.start(); // Start processing in a separate thread (non-blocking)\nstreamProcessor.join(); // Wait for the thread to finish (blocking)\n\n// Access aggregated information from total output\nInteger tokensUsed = totalOutput.getUsage().getCompletionTokens();\nSystem.out.println("Tokens used: " + tokensUsed);\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Please find ",(0,i.jsx)(n.a,{href:"https://github.com/SAP/ai-sdk-java/tree/main/sample-code/spring-app/src/main/java/com/sap/ai/sdk/app/services/OpenAiService.java",children:"an example in our Spring Boot application"}),". It shows the usage of Spring\nBoot's ",(0,i.jsx)(n.code,{children:"ResponseBodyEmitter"})," to stream the chat completion delta messages to the frontend in real-time."]}),"\n",(0,i.jsx)(n.h2,{id:"embedding",children:"Embedding"}),"\n",(0,i.jsx)(n.p,{children:"Get the embeddings of a text input in list of float values:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'var request = new OpenAiEmbeddingParameters().setInput("Hello World");\n\nOpenAiEmbeddingOutput embedding = OpenAiClient.forModel(TEXT_EMBEDDING_ADA_002).embedding(request);\n'})}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"https://github.com/SAP/ai-sdk-java/tree/main/sample-code/spring-app/src/main/java/com/sap/ai/sdk/app/services/OpenAiService.java",children:"an example in our Spring Boot application"})]})]})}function p(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var s=t(6540);const i={},o=s.createContext(i);function a(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);