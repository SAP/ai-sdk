"use strict";(self.webpackChunksap_ai_sdk_documentation=self.webpackChunksap_ai_sdk_documentation||[]).push([[938],{4659:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"guides/openai-chat-completion","title":"OpenAI Chat Completion","description":"How to use the SAP AI SDK for Java to perform chat completion tasks using OpenAI models deployed on SAP AI Core.","source":"@site/docs-java/guides/openai-chat-completion.mdx","sourceDirName":"guides","slug":"/guides/openai-chat-completion","permalink":"/ai-sdk/docs/java/guides/openai-chat-completion","draft":false,"unlisted":false,"editUrl":"https://github.com/SAP/ai-sdk/edit/main/docs-java/guides/openai-chat-completion.mdx","tags":[],"version":"current","frontMatter":{"id":"openai-chat-completion","title":"OpenAI Chat Completion","hide_title":false,"hide_table_of_contents":false,"description":"How to use the SAP AI SDK for Java to perform chat completion tasks using OpenAI models deployed on SAP AI Core.","keywords":["sap","cloud","sdk","ai"]},"sidebar":"docsJavaSidebar","previous":{"title":"AI Core Deployment","permalink":"/ai-sdk/docs/java/guides/ai-core-deployment"},"next":{"title":"Orchestration Service","permalink":"/ai-sdk/docs/java/guides/orchestration-chat-completion"}}');var i=s(4848),o=s(8453);const a={id:"openai-chat-completion",title:"OpenAI Chat Completion",hide_title:!1,hide_table_of_contents:!1,description:"How to use the SAP AI SDK for Java to perform chat completion tasks using OpenAI models deployed on SAP AI Core.",keywords:["sap","cloud","sdk","ai"]},r=void 0,l={},c=[{value:"Introduction",id:"introduction",level:2},{value:"New User Interface (v1.4.0)",id:"new-user-interface-v140",level:3},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Maven Dependencies",id:"maven-dependencies",level:3},{value:"Usage",id:"usage",level:2},{value:"Simple chat completion",id:"simple-chat-completion",level:2},{value:"Using a Custom Resource Group",id:"using-a-custom-resource-group",level:2},{value:"Message history",id:"message-history",level:2},{value:"Chat Completion with Specific Model Version",id:"chat-completion-with-specific-model-version",level:2},{value:"Chat completion with Custom Model",id:"chat-completion-with-custom-model",level:2},{value:"Stream chat completion",id:"stream-chat-completion",level:2},{value:"Asynchronous Streaming - Blocking",id:"asynchronous-streaming---blocking",level:3},{value:"Asynchronous Streaming - Non-blocking",id:"asynchronous-streaming---non-blocking",level:3},{value:"Embedding",id:"embedding",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components},{Details:s}=n;return s||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(n.p,{children:"This guide demonstrates how to use the SAP AI SDK for Java to perform chat completion tasks using OpenAI models deployed on SAP AI Core."}),"\n",(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsxs)(n.p,{children:["All classes under any of the ",(0,i.jsx)(n.code,{children:"...model"})," packages are generated from an OpenAPI specification and marked as ",(0,i.jsx)(n.code,{children:"@Beta"}),".\nThis means that these model classes are not guaranteed to be stable and may change with future releases.\nThey are safe to use, but may require updates even in minor releases."]})}),"\n",(0,i.jsx)(n.h3,{id:"new-user-interface-v140",children:"New User Interface (v1.4.0)"}),"\n",(0,i.jsxs)(n.p,{children:["We're excited to introduce a new user interface for OpenAI chat completions starting with ",(0,i.jsx)(n.strong,{children:"version 1.4.0"}),". This update is designed to improve the SDK by:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Decoupling Layers:"})," Separating the convenience layer from the model classes to deliver a more stable and maintainable experience."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Staying Current:"})," Making it easier for the SDK to adapt to the latest changes in the OpenAI API specification."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Consistent Design:"})," Aligning with the Orchestrator convenience API for a smoother transition and easier adoption."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Please Note:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The new interface is gradually being rolled out across the SDK."}),"\n",(0,i.jsx)(n.li,{children:"We welcome your feedback to help us refine this interface."}),"\n",(0,i.jsx)(n.li,{children:"The existing interface (v1.0.0) remains available for compatibility."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsxs)(n.p,{children:["Before using the AI Core module, ensure that you have met all the general requirements outlined in the ",(0,i.jsx)(n.a,{href:"../overview-cloud-sdk-for-ai-java#general-requirements",children:"overview"}),".\nAdditionally, include the necessary Maven dependency in your project."]}),"\n",(0,i.jsx)(n.h3,{id:"maven-dependencies",children:"Maven Dependencies"}),"\n",(0,i.jsxs)(n.p,{children:["Add the following dependency to your ",(0,i.jsx)(n.code,{children:"pom.xml"})," file:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"<dependencies>\n    <dependency>\n        <groupId>com.sap.ai.sdk.foundationmodels</groupId>\n        <artifactId>openai</artifactId>\n        <version>${ai-sdk.version}</version>\n    </dependency>\n</dependencies>\n"})}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"https://github.com/SAP/ai-sdk-java/tree/main/sample-code/spring-app/pom.xml",children:"an example pom in our Spring Boot application"})]}),"\n",(0,i.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,i.jsx)(n.p,{children:"In addition to the prerequisites above, we assume you have already set up the following to carry out the examples in this guide:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"A Deployed OpenAI Model in SAP AI Core"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Refer\nto ",(0,i.jsx)(n.a,{href:"https://help.sap.com/docs/sap-ai-core/sap-ai-core-service-guide/create-deployment-for-generative-ai-model-in-sap-ai-core",children:"How to deploy a model to AI Core"}),"\nfor setup instructions."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["In case the model is deployed in a custom resource group, refer to ",(0,i.jsx)(n.a,{href:"#using-a-custom-resource-group",children:"this section"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(s,{children:[(0,i.jsxs)("summary",{children:["Example deployed model from the AI Core ",(0,i.jsx)("code",{children:"/deployments"})," endpoint"]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "id": "d123456abcdefg",\n  "deploymentUrl": "https://api.ai.region.aws.ml.hana.ondemand.com/v2/inference/deployments/d123456abcdefg",\n  "configurationId": "12345-123-123-123-123456abcdefg",\n  "configurationName": "gpt-4o-mini",\n  "scenarioId": "foundation-models",\n  "status": "RUNNING",\n  "statusMessage": null,\n  "targetStatus": "RUNNING",\n  "lastOperation": "CREATE",\n  "latestRunningConfigurationId": "12345-123-123-123-123456abcdefg",\n  "ttl": null,\n  "details": {\n    "scaling": {\n      "backendDetails": {}\n    },\n    "resources": {\n      "backendDetails": {\n        "model": {\n          "name": "gpt-4o-mini",\n          "version": "latest"\n        }\n      }\n    }\n  },\n  "createdAt": "2024-07-03T12:44:22Z",\n  "modifiedAt": "2024-07-16T12:44:19Z",\n  "submissionTime": "2024-07-03T12:44:51Z",\n  "startTime": "2024-07-03T12:45:56Z",\n  "completionTime": null\n}\n'})})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"simple-chat-completion",children:"Simple chat completion"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'var result =\n    OpenAiClient.forModel(GPT_4O_MINI)\n        .withSystemPrompt("You are a helpful AI")\n        .chatCompletion("Hello World! Why is this phrase so famous?");\n\nString resultMessage = result.getContent();\n'})}),"\n",(0,i.jsx)(n.h2,{id:"using-a-custom-resource-group",children:"Using a Custom Resource Group"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'var destination = new AiCoreService()\n    .getInferenceDestination("custom-rg")\n    .forModel(GPT_4O);\nOpenAiClient.withCustomDestination(destination);\n'})}),"\n",(0,i.jsx)(n.h2,{id:"message-history",children:"Message history"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Since v1.4.0"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'var request =\n    new OpenAiChatCompletionRequest(\n        OpenAiMessage.system("You are a helpful assistant"),\n        OpenAiMessage.user("Hello World! Why is this phrase so famous?"));\n\nvar response = OpenAiClient.forModel(GPT_4O).chatCompletion(request).getContent();\n'})}),"\n",(0,i.jsxs)(s,{children:[(0,i.jsx)("summary",{children:(0,i.jsx)("b",{children:"Since v1.0.0"})}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'var systemMessage =\n    new OpenAiChatSystemMessage().setContent("You are a helpful assistant");\nvar userMessage =\n    new OpenAiChatUserMessage().addText("Hello World! Why is this phrase so famous?");\nvar request =\n    new OpenAiChatCompletionParameters().addMessages(systemMessage, userMessage);\n\nvar result = OpenAiClient.forModel(GPT_4O_MINI).chatCompletion(request);\n\nString resultMessage = result.getContent();\n'})}),(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"https://github.com/SAP/ai-sdk-java/tree/main/sample-code/spring-app/src/main/java/com/sap/ai/sdk/app/services/OpenAiService.java",children:"an example in our Spring Boot application"})]})]}),"\n",(0,i.jsx)(n.h2,{id:"chat-completion-with-specific-model-version",children:"Chat Completion with Specific Model Version"}),"\n",(0,i.jsx)(n.p,{children:"By default, when no version is specified, the system selects one of the available deployments of the specified model, regardless of its version.\nTo target a specific version, you can specify the model version along with the model."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'OpenAiChatCompletionOutput result =\n    OpenAiClient.forModel(GPT_4O_MINI.withVersion("1106")).chatCompletion(request);\n'})}),"\n",(0,i.jsx)(n.h2,{id:"chat-completion-with-custom-model",children:"Chat completion with Custom Model"}),"\n",(0,i.jsxs)(n.p,{children:["You can also use a custom OpenAI model for chat completion by creating an ",(0,i.jsx)(n.code,{children:"OpenAiModel"})," object."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'OpenAiChatCompletionOutput result =\n    OpenAiClient.forModel(new OpenAiModel("custom-model", "v1")).chatCompletion(request);\n'})}),"\n",(0,i.jsx)(n.p,{children:"Ensure that the custom model is deployed in SAP AI Core."}),"\n",(0,i.jsx)(n.h2,{id:"stream-chat-completion",children:"Stream chat completion"}),"\n",(0,i.jsx)(n.p,{children:"It's possible to pass a stream of chat completion delta elements, e.g. from the application backend to the frontend in real-time."}),"\n",(0,i.jsx)(n.h3,{id:"asynchronous-streaming---blocking",children:"Asynchronous Streaming - Blocking"}),"\n",(0,i.jsx)(n.p,{children:"This is a blocking example for streaming and printing directly to the console:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'String msg = "Can you give me the first 100 numbers of the Fibonacci sequence?";\n\nOpenAiClient client = OpenAiClient.forModel(GPT_4O_MINI);\n\n// try-with-resources on stream ensures the connection will be closed\ntry (Stream<String> stream = client.streamChatCompletion(msg)) {\n    stream.forEach(\n        deltaString -> {\n            System.out.print(deltaString);\n            System.out.flush();\n        });\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"asynchronous-streaming---non-blocking",children:"Asynchronous Streaming - Non-blocking"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Since v1.4.0"})}),"\n",(0,i.jsx)(n.p,{children:'The following example demonstrate how you can leverage a concurrency-safe container (like an AtomicReference) to "listen" for usage information in any incoming delta.'}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'String question = "Can you give me the first 100 numbers of the Fibonacci sequence?";\nvar userMessage = OpenAiMessage.user(question);\nvar request = new OpenAiChatCompletionRequest(userMessage);\n\nOpenAiClient client = OpenAiClient.forModel(GPT_4O);\nvar usageRef = new AtomicReference<CompletionUsage>();\n\n// Prepare the stream before starting the thread to handle any initialization exceptions\nStream<OpenAiChatCompletionDelta> stream = client.streamChatCompletionDeltas(request);\n\n// Create a new thread for asynchronous, non-blocking processing\nThread streamProcessor =\n    new Thread(\n        () -> {\n            // try-with-resources ensures the stream is closed after processing\n            try (stream) {\n                stream.forEach(\n                    delta -> {\n                        usageRef.compareAndExchange(null, delta.getCompletionUsage());\n                        System.out.println("Content: " + delta.getDeltaContent());\n                    });\n            }\n        });\n\n// Start the processing thread; the main thread remains free (non-blocking)\nstreamProcessor.start();\n// Wait for the thread to finish (blocking)\nstreamProcessor.join();\n\n// Access information caught from completion usage\nInteger tokensUsed = usageRef.get().getCompletionTokens();\nSystem.out.println("Tokens used: " + tokensUsed);\n'})}),"\n",(0,i.jsxs)(s,{children:[(0,i.jsx)("summary",{children:(0,i.jsx)("b",{children:"Since v1.0.0"})}),(0,i.jsx)(n.p,{children:"The following example is non-blocking and demonstrates how to aggregate the complete response.\nAny asynchronous library can be used, such as the classic Thread API."}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'var question = "Can you give me the first 100 numbers of the Fibonacci sequence?";\n\nvar userMessage =\n    new OpenAiChatMessage.OpenAiChatUserMessage().addText(question);\nvar requestParameters =\n    new OpenAiChatCompletionParameters().addMessages(userMessage);\n\nvar client = OpenAiClient.forModel(GPT_4O_MINI);\nvar totalOutput = new OpenAiChatCompletionOutput();\n\n// Prepare the stream before starting the thread to handle any initialization exceptions\nStream<OpenAiChatCompletionDelta> stream =\n    client.streamChatCompletionDeltas(requestParameters);\n\nvar streamProcessor =\n    new Thread(\n        () -> {\n          // try-with-resources ensures the stream is closed after processing\n          try (stream) {\n            stream.peek(totalOutput::addDelta).forEach(System.out::println);\n          }\n        });\n\nstreamProcessor.start(); // Start processing in a separate thread (non-blocking)\nstreamProcessor.join(); // Wait for the thread to finish (blocking)\n\n// Access aggregated information from total output\nInteger tokensUsed = totalOutput.getUsage().getCompletionTokens();\nSystem.out.println("Tokens used: " + tokensUsed);\n'})}),(0,i.jsxs)(n.p,{children:["Please find ",(0,i.jsx)(n.a,{href:"https://github.com/SAP/ai-sdk-java/tree/main/sample-code/spring-app/src/main/java/com/sap/ai/sdk/app/services/OpenAiService.java",children:"an example in our Spring Boot application"}),". It shows the usage of Spring\nBoot's ",(0,i.jsx)(n.code,{children:"ResponseBodyEmitter"})," to stream the chat completion delta messages to the frontend in real-time."]})]}),"\n",(0,i.jsx)(n.h2,{id:"embedding",children:"Embedding"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Since v1.4.0"})}),"\n",(0,i.jsx)(n.p,{children:"Get the embeddings of a text input in list of float values:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'var request = new OpenAiEmbeddingRequest(List.of("Hello World"));\n\nOpenAiEmbeddingResponse response = OpenAiClient.forModel(TEXT_EMBEDDING_3_SMALL).embedding(request);\nfloat[] embedding = embedding.getEmbeddings().get(0);\n'})}),"\n",(0,i.jsxs)(s,{children:[(0,i.jsx)("summary",{children:(0,i.jsx)("b",{children:"Since v1.0.0"})}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'var request = new OpenAiEmbeddingParameters().setInput("Hello World");\n\nOpenAiEmbeddingOutput embedding = OpenAiClient.forModel(TEXT_EMBEDDING_3_SMALL).embedding(request);\n\nfloat[] embedding = embedding.getData().get(0).getEmbedding();\n'})}),(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"https://github.com/SAP/ai-sdk-java/tree/main/sample-code/spring-app/src/main/java/com/sap/ai/sdk/app/services/OpenAiService.java",children:"an example in our Spring Boot application"})]})]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>r});var t=s(6540);const i={},o=t.createContext(i);function a(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);